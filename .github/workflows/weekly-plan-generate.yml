name: Generate Meal Plan

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  generate-plan:
    if: |
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'weekly-planning')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pyyaml beautifulsoup4

      - name: Generate meal plan
        id: generate
        run: |
          # Run workflow to generate plan
          python3 scripts/workflow.py generate-plan

          # Extract week date
          WEEK_DATE=$(ls -t plans/*.html | head -1 | xargs basename | cut -d- -f1,2,3)
          echo "week_date=$WEEK_DATE" >> $GITHUB_OUTPUT

      - name: Initialize Inventory
        run: |
          # Extract vegetables from generated plan to history.yml
          python3 scripts/init_week_vegetables.py --week ${{ steps.generate.outputs.week_date }}


      - name: Commit generated plan
        run: |
          git config user.name "Meal Planner Bot"
          git config user.email "mealplanner@users.noreply.github.com"
          git add plans/ data/history.yml inputs/
          git commit -m "Generate meal plan for week of ${{ steps.generate.outputs.week_date }}" || echo "No changes to commit"
          git push

      - name: Comment on PR with plan link
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âœ… **Meal plan generated successfully!**

            ðŸ“„ **View your plan here:**
            https://ssimhan.github.io/meal-planner/plans/${{ steps.generate.outputs.week_date }}-weekly-plan.html

            ---
            ðŸ¤– Generated by Meal Plan workflow
