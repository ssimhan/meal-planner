name: Start Weekly Meal Planning

on:
  schedule:
    - cron: '0 16 * * SUN'  # 8am PST = 16:00 UTC (Sunday)
  workflow_dispatch:  # Manual trigger for testing

jobs:
  create-weekly-input:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Create input file with farmers market suggestions
        id: create-input
        run: |
          # Run workflow to create input file
          python3 scripts/workflow.py start-week

          # Extract week date for use in PR
          WEEK_DATE=$(ls -t inputs/*.yml | head -1 | xargs basename | cut -d. -f1)
          echo "week_date=$WEEK_DATE" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Weekly planning: Propose farmers market for week of ${{ steps.create-input.outputs.week_date }}"
          branch: weekly-plan/${{ steps.create-input.outputs.week_date }}
          title: "ðŸ¥• Week of ${{ steps.create-input.outputs.week_date }}: Review Farmers Market Suggestions"
          body: |
            ## Weekly Meal Planning - Step 1

            Review the proposed farmers market vegetables for this week.

            ### What to do:
            1. Click "Files changed" tab above
            2. Review `inputs/${{ steps.create-input.outputs.week_date }}.yml`
            3. Click the pencil icon to edit the file
            4. Update `confirmed_veg` with what you actually bought
            5. Change `status: proposed` to `status: confirmed`
            6. Commit changes
            7. Merge this PR when ready

            ### What happens next:
            - Merging this PR will automatically generate your meal plan
            - You'll get a comment with a link to view the plan
            - The plan will be accessible at: https://ssimhan.github.io/meal-planner/plans/${{ steps.create-input.outputs.week_date }}-weekly-plan.html

            ---
            ðŸ¤– Generated by Weekly Meal Planning workflow
          labels: weekly-planning
