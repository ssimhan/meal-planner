#!/bin/bash
# Meal Planner - Easy CLI wrapper
# Makes the meal planner commands shorter and easier to use

set -e  # Exit on error

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

usage() {
    echo "Meal Planner - Quick Commands"
    echo ""
    echo "Usage:"
    echo "  ./mealplan <command> [args]"
    echo ""
    echo "ðŸŒŸ NEW Streamlined Workflow:"
    echo "  next               Auto-detect and run next workflow step"
    echo "  status             Show current workflow status"
    echo "  reset              Start planning next week"
    echo ""
    echo "Legacy Workflow Commands:"
    echo "  1-start            Start new week (interactive prompts)"
    echo "  2-update [date]    Update vegetables after farmers market"
    echo "  3-plan [date]      Generate meal plan"
    echo "  4-view [date]      View a specific plan"
    echo "  5-latest           View the most recent plan"
    echo ""
    echo "Other Commands:"
    echo "  parse              Parse HTML recipes into index (one-time setup)"
    echo "  validate [date]    Validate a meal plan"
    echo ""
    echo "Examples (NEW STREAMLINED WORKFLOW):"
    echo "  ./mealplan next    # Auto-runs next step (recommended!)"
    echo "  ./mealplan status  # Check current state"
    echo "  ./mealplan reset   # Start new week when current is complete"
    echo ""
    echo "Examples (Legacy):"
    echo "  ./mealplan 1-start             # Start new week"
    echo "  ./mealplan 2-update 2026-01-05 # Edit vegetables after farmers market"
    echo "  ./mealplan 3-plan 2026-01-05   # Generate plan"
    echo ""
    exit 1
}

# Command handlers

# New streamlined workflow commands
cmd_next() {
    echo -e "${GREEN}Running next workflow step...${NC}"
    python3 scripts/workflow.py
}

cmd_status() {
    python3 scripts/workflow.py --status
}

cmd_reset() {
    python3 scripts/workflow.py --reset
}

# Legacy commands
cmd_parse() {
    echo -e "${GREEN}Parsing HTML recipes...${NC}"
    python3 scripts/parse_recipes.py
}

cmd_start() {
    echo -e "${GREEN}Starting new week...${NC}"
    python3 scripts/mealplan.py intake
}

cmd_update() {
    local date="$1"

    if [ -z "$date" ]; then
        echo -e "${RED}Error: Date required${NC}"
        echo "Usage: ./mealplan 2-update YYYY-MM-DD"
        echo "Example: ./mealplan 2-update 2026-01-05"
        exit 1
    fi

    local input_file="inputs/${date}.yml"

    if [ ! -f "$input_file" ]; then
        echo -e "${RED}Error: Input file not found: ${input_file}${NC}"
        echo "Run './mealplan 1-start' first"
        exit 1
    fi

    # Use user's preferred editor or fallback to vim
    ${EDITOR:-vim} "$input_file"

    echo ""
    echo -e "${YELLOW}Remember to:${NC}"
    echo "  1. Update 'confirmed_veg' with actual farmers market purchases"
    echo "  2. Change 'status: proposed' to 'status: confirmed'"
    echo ""
    echo "Then run: ./mealplan 3-plan $date"
}

cmd_plan() {
    local date="$1"

    if [ -z "$date" ]; then
        echo -e "${RED}Error: Date required${NC}"
        echo "Usage: ./mealplan 3-plan YYYY-MM-DD"
        echo "Example: ./mealplan 3-plan 2026-01-05"
        exit 1
    fi

    local input_file="inputs/${date}.yml"

    if [ ! -f "$input_file" ]; then
        echo -e "${RED}Error: Input file not found: ${input_file}${NC}"
        echo "Run './mealplan 1-start' first to create an input file"
        exit 1
    fi

    echo -e "${GREEN}Generating meal plan for week of ${date}...${NC}"
    python3 scripts/mealplan.py plan "$input_file"

    echo ""
    echo -e "${GREEN}âœ“ Plan created!${NC}"
    echo "View it with: ./mealplan 4-view $date"
}

cmd_validate() {
    local date="$1"

    if [ -z "$date" ]; then
        echo -e "${RED}Error: Date required${NC}"
        echo "Usage: ./mealplan validate YYYY-MM-DD"
        exit 1
    fi

    local plan_file="plans/${date}-weekly-plan.md"
    local input_file="inputs/${date}.yml"

    if [ ! -f "$plan_file" ]; then
        echo -e "${RED}Error: Plan file not found: ${plan_file}${NC}"
        exit 1
    fi

    if [ ! -f "$input_file" ]; then
        echo -e "${RED}Error: Input file not found: ${input_file}${NC}"
        exit 1
    fi

    echo -e "${GREEN}Validating meal plan for ${date}...${NC}"
    python3 scripts/validate_plan.py "$plan_file" "$input_file"
}

cmd_view() {
    local date="$1"

    if [ -z "$date" ]; then
        echo -e "${RED}Error: Date required${NC}"
        echo "Usage: ./mealplan 4-view YYYY-MM-DD"
        echo "Or use: ./mealplan 5-latest"
        exit 1
    fi

    local plan_file="plans/${date}-weekly-plan.md"

    if [ ! -f "$plan_file" ]; then
        echo -e "${RED}Error: Plan file not found: ${plan_file}${NC}"
        exit 1
    fi

    if command -v bat &> /dev/null; then
        # Use bat if available (syntax highlighting)
        bat "$plan_file"
    elif command -v glow &> /dev/null; then
        # Use glow if available (pretty markdown rendering)
        glow "$plan_file"
    else
        # Fallback to cat
        cat "$plan_file"
    fi
}

cmd_latest() {
    # Find the most recent plan file
    local latest_plan=$(ls -t plans/*.md 2>/dev/null | head -1)

    if [ -z "$latest_plan" ]; then
        echo -e "${RED}Error: No meal plans found in plans/ directory${NC}"
        exit 1
    fi

    echo -e "${GREEN}Showing latest plan: ${latest_plan}${NC}"
    echo ""

    if command -v bat &> /dev/null; then
        bat "$latest_plan"
    elif command -v glow &> /dev/null; then
        glow "$latest_plan"
    else
        cat "$latest_plan"
    fi
}

# Main command dispatcher

if [ $# -eq 0 ]; then
    usage
fi

command="$1"
shift

case "$command" in
    # New streamlined workflow
    next)
        cmd_next
        ;;
    status)
        cmd_status
        ;;
    reset)
        cmd_reset
        ;;
    # Numbered workflow commands (legacy)
    1-start|start)
        cmd_start
        ;;
    2-update|update)
        cmd_update "$@"
        ;;
    3-plan|plan)
        cmd_plan "$@"
        ;;
    4-view|view)
        cmd_view "$@"
        ;;
    5-latest|latest)
        cmd_latest
        ;;
    # Other commands
    parse)
        cmd_parse
        ;;
    validate)
        cmd_validate "$@"
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        echo -e "${RED}Error: Unknown command: $command${NC}"
        echo ""
        usage
        ;;
esac
